<!--
Copyright 2018 Google LLC

Use of this source code is governed by an MIT-style
license that can be found in the LICENSE file or at
https://opensource.org/licenses/MIT.
=============================================================================
-->

<!doctype html>
<head>
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.cyan-teal.min.css" />
  <script src="../dist/tfjs_layers.debug.js"></script>
</head>

<body>
  <style>
    #review-text {
      font-size: 120%;
      width: 60%;
      height: 200px;
    }
  </style>
  <h1>
    TensorFlow.js Layers: IMDB Demo
  </h1>
  <div>
    <div>
      <span>Model type: </span>
      <span id="modelType"></span>
    </div>
    <div>
      <span>Vocabulary size: </span>
      <span id="vocabularySize"></span>
    </div>
    <div>
      <span>Max length: </span>
      <span id="maxLen"></span>
    </div>
  </div>
  <div>
    <select id="test-example-select" class="form-control">
      <option value="positive">Positive example</option>
      <option value="negative">Negative example</option>
    </select>
  </div>
  <div>
    <textarea id="review-text"></textarea>
  </div>
  <div>
    <button id="run-inference">Run inference</button>
    <span id="status">Standing by.</span>
  </div>

  <script>
    (async () => {
      const artifactsDir = '../../dist/demo/imdb/'

      const imdbMetadataJSON =
          await (await fetch(artifactsDir + 'imdb.metadata.json')).json();

      document.getElementById('modelType').textContent =
          imdbMetadataJSON['model_type'];
      document.getElementById('vocabularySize').textContent =
          imdbMetadataJSON['vocabulary_size'];
      document.getElementById('maxLen').textContent =
          imdbMetadataJSON['max_len'];

      const exampleReviews = {
        'positive': 'die hard mario fan and i loved this game br br this game starts slightly boring but trust me it\'s worth it as soon as you start your hooked the levels are fun and exiting they will hook you OOV your mind turns to mush i\'m not kidding this game is also orchestrated and is beautifully done br br to keep this spoiler free i have to keep my mouth shut about details but please try this game it\'ll be worth it br br story 9 9 action 10 1 it\'s that good OOV 10 attention OOV 10 average 10',
        'negative': 'the mother in this movie is reckless with her children to the point of neglect i wish i wasn\'t so angry about her and her actions because i would have otherwise enjoyed the flick what a number she was take my advise and fast forward through everything you see her do until the end also is anyone else getting sick of watching movies that are filmed so dark anymore one can hardly see what is being filmed as an audience we are impossibly involved with the actions on the screen so then why the hell can\'t we have night vision'
      }
      const testExampleSelect = document.getElementById('test-example-select');
      const reviewText = document.getElementById('review-text');
      const runInference = document.getElementById('run-inference');
      testExampleSelect.addEventListener('change', () => {
        reviewText.value = exampleReviews[testExampleSelect.value];
      });
      reviewText.value = exampleReviews['positive'];

      const indexFrom = imdbMetadataJSON['index_from'];
      const maxLen = imdbMetadataJSON['max_len'];
      console.log("indexFrom = " + indexFrom);
      console.log("maxLen = " + maxLen);

      const wordIndex = imdbMetadataJSON['word_index']

      console.log('Loading model architecture');
      const model = await tfjs_layers.loadModel(artifactsDir + 'model.json');
      console.log('Loading model weights');

      runInference.addEventListener('click', async () => {
        // Convert to lower case and remove all punctuations.
        const inputText = reviewText.value
            .trim().toLowerCase().replace(/(\.|\,|\!)/g, '').split(' ');
        // Look up word indices.
        const inputBuffer = tfjs_layers.dl.buffer([1, maxLen], 'float32');
        for (let i = 0; i < inputText.length; ++i) {
          // TODO(cais): Deal with OOV words.
          const word = inputText[i];
          inputBuffer.set(wordIndex[word] + indexFrom, 0, i);
        }
        const input = inputBuffer.toTensor();
        console.log('inputBuffer.values:', inputBuffer.values);

        document.getElementById('status').textContent = 'Running inference';
        const beginMs = performance.now();
        const predictOut = await model.predict(input);
        const score = predictOut.dataSync()[0];
        predictOut.dispose();
        const endMs = performance.now();

        document.getElementById('status').textContent =
            'Inference result (0 - negative; 1 - positive): ' + score +
            ' (elapsed: ' + (endMs - beginMs) + ' ms)';
      });
    })();
  </script>
</body>
