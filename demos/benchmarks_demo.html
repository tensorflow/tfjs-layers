<!--
Copyright 2018 Google LLC

Use of this source code is governed by an MIT-style
license that can be found in the LICENSE file or at
https://opensource.org/licenses/MIT.
=============================================================================
-->

<!doctype html>
<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="../dist/tfjs_layers.debug.js"></script>
</head>

<style>
  body {
    font-family: monospace;
    margin-left: 1em;
    margin-top: 1em;
  }
  table, th, td {
    border: 1px solid black;
    padding: 0.5em;
  }
  table > thead {
    font-weight: bold;
  }
  #controlSection {
    padding-bottom: 1em;
  }
  .metadata {
    padding-left: 1em;
  }
</style>

<body>
  <h1>TensorFlow.js Layers: Benchmarks Demo</h1>
  <div id='controlSection'>
    <button id="runBenchmarks">Run Benchmarks</button>
    <span id="status">Standing by.</span>
  </div>
  <div>
    PyKeras version:<span class="metadata" id="pyKerasVersion"></span>
  </div>
  <div>
    TensorFlow version:<span class="metadata" id="tfVersion"></span>
  </div>
  <div>
    TensorFlow uses GPU:<span class="metadata" id="tfUsesGPU"></span>
  </div>

  <table id='resultsTable'>
    <thead>
      <td>Model name</td>
      <td>Model description</td>
      <td>Batch size</td>
      <td>fit() epochs</td>
      <td>fit() (ms)<br/>PyKeras</td>
      <td>fit() (ms)<br/>TF.js Layers</td>
      <td>predict() (ms)<br/>PyKeras</td>
      <td>predict() (ms)<br/>TF.js Layers</td>
    </thead>
    <tbody>

    </tbody>
  </table>
  <script>
    (async () => {
      const artifactsDir = '../../dist/demo/benchmarks/';

      console.log('Loading benchmarks...');
      const benchmarks =
          await (await fetch(artifactsDir + 'benchmarks.json')).json();
      console.log('Done loading benchmarks:', benchmarks);

      const lossMap = {
        mean_squared_error: 'meanSquaredError',
        categorical_crossentropy: 'categoricalCrossentropy',
      };
      // TODO(cais): Maybe TF.js Layers should tolerate these Python-style names
      // for losses.

      $('#pyKerasVersion').text(benchmarks.metadata.keras_version);
      $('#tfVersion').text(benchmarks.metadata.tensorflow_version);
      $('#tfUsesGPU').text(benchmarks.metadata.tensorflow_uses_gpu);

      const FIT_BURNIN_EPOCHS = benchmarks.config.FIT_BURNIN_EPOCHS;
      const PREDICT_BURNINS = benchmarks.config.PREDICT_BURNINS;
      const PREDICT_RUNS = benchmarks.config.PREDICT_RUNS;

      async function runBenchmark(modelName) {
        const modelPath = artifactsDir + modelName + '/';
        console.log('Loading model "' + modelName + '" and benchmark data...');
        const model = await tfjs_layers.loadModel(modelPath + 'model.json');
        console.log('Done loading model "' + modelName + '" and benchmark data.');

        const benchmarkData = await (await fetch(modelPath + 'data.json')).json();

        const batchSize = benchmarkData.batch_size;
        const xs = tfjs_layers.backend.randomUniform(
            [batchSize].concat(benchmarkData.input_shape));
        const ys = tfjs_layers.backend.randomUniform(
            [batchSize].concat(benchmarkData.target_shape));
        model.compile({
          optimizer: benchmarkData.optimizer,
          loss: lossMap[benchmarkData.loss],
        });

        // Perform fit() burn-in.
        await model.fit(xs, ys, {
          batchSize: benchmarkData.batch_size,
          epochs: FIT_BURNIN_EPOCHS});
        model.trainableWeights[0].read().dataSync();

        const trainBeginMs = performance.now();
        await model.fit(xs, ys, {
          batchSize: benchmarkData.batch_size,
          epochs: benchmarkData.train_epochs});
        // After the fit() call, call dataSync() to let the scheduled GPU
        // operations to complete before proceeding.
        model.trainableWeights[0].read().dataSync();
        const trainEndMs = performance.now();
        const trainTimeMs = (trainEndMs - trainBeginMs) / benchmarkData.train_epochs;

        // Perform predict() burn-in.
        let output;
        for (let i = 0; i < PREDICT_BURNINS; ++i) {
          output = model.predict(xs);
        }
        // Time predict() a number of times and take the average.
        const predictBeginMs = performance.now();
        for (let i = 0; i < PREDICT_RUNS; ++i) {
          output = model.predict(xs);
        }
        // After all the model.predict() calls, invoke dataSync() once to let the
        // scheduled GPU operations complete before proceeding.
        output.dataSync();
        const predictEndMs = performance.now();
        const predictTimeMs = (predictEndMs - predictBeginMs) / PREDICT_RUNS;
        return {
          originalData: benchmarkData,
          predictTimeMs: predictTimeMs,
          trainTimeMs: trainTimeMs,
        };
      }

      $('#runBenchmarks').click(() => {
        $('#status').text('Running benchmarks...');
        const run = async () => {
          for (let i = 0; i < benchmarks.models.length; ++i) {
            const modelName = benchmarks.models[i];
            $('#status').text(
                'Running model (' + (i + 1) + ' of ' + benchmarks.models.length +
                '): "' + modelName +
                '" ... (Please wait patiently. Do NOT click anything.)');
            await tfjs_layers.dl.nextFrame();
            console.log('Benchmarking model: ' + modelName);
            const result = await runBenchmark(modelName);
            $('#resultsTable').find('tbody')
                .append($('<tr>')
                    .append($('<td>').append(modelName))
                    .append($('<td>').append(result.originalData.description))
                    .append($('<td>').append(result.originalData.batch_size))
                    .append($('<td>').append(result.originalData.train_epochs))
                    .append($('<td>').append((result.originalData.train_time * 1e3).toFixed(1)))
                    .append($('<td>').append(result.trainTimeMs.toFixed(1)))
                    .append($('<td>').append((result.originalData.predict_time * 1e3).toFixed(1)))
                    .append($('<td>').append(result.predictTimeMs.toFixed(1))));
          }
          $('#status').text('Standing by.');
        };
        run();
      });
    })();
  </script>
</body>
